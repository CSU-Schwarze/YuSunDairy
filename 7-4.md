### 7.4
#### 作业讲解
```
打开靶机，利用nmap找到靶机的IP，在Burpsuite的浏览器中访问靶机IP，利用dirb或dirsearch对靶机进行目录扫描，利用-x参数可以屏蔽指定的返回状态码，简化扫描的目录列表；找到robots.txt，是网站搭建的默认文件，可以在里面找到站点的一些目录，对其中一个目录访问可以发现站点具有SQL注入漏洞，是采用POST请求进行的，运行SQLMap进行测试，在这里需要确认一下MySQL数据库版本信息，在5.5版本以前，secure_file_priv默认是空，这个情况下可以向任意绝对路径写文件；在5.5版本之后，secure_file_priv默认是NULL，这个情况下不可以写文件，也可能是一个目录，即只允许向该目录写入文件。对robots.txt下的目录进行递归扫描发现了phpinfo文件，其中显示了网站的绝对路径、操作系统信息，用SQLMap向uploads目录下上传三个php文件，其中一个文件可以利用cmd参数进行shell命令的运行，另一个文件可以上传文件，上传哥斯拉木马，访问哥斯拉木马，然后在哥斯拉进行查看；也可以在获取了网站的绝对路径后将哥斯拉的木马直接上传到uploads文件。随后使用哥斯拉进行数据库管理，利用获取到的数据库用户名和密码连接数据库，获取需要的信息

首先需要确认secure_file_priv是否为空；其次需要网站的绝对路径，可以通过网站的报错信息、phpinfo、/var/www/html（Ubuntu）；之后要确定网站的目录权限，是否有写入权限

--os-shell：MySQL的--os-shell参数是SQLMap向服务器写入了自己内置的一个木马，MsSQL的--os-shell参数是SQLMap打开了MsSQL的xp_cmdshell的一个函数
```
#### 文件上传漏洞
```
如果我们可以上传脚本文件到服务器，使脚本文件被运行，脚本文件可以包括大量与系统交互的函数，例如常见的一句话木马<?php @eval($_POST['cmd']);?>，意思是当向php脚本文件传入参数cmd=system('ls');时，传入参数cmd会作为PHP命令执行，可以执行系统外部命令（如system()、exec()、passthru()），也可以将木马改为GET以及其他形式

流程是攻击者上传恶意文件到服务器，恶意代码在服务器被运行，运行结果返回给攻击者

文件上传漏洞利用成功的条件：上传的脚本文件可以被解析；需要知道上传文件的路径

文件上传漏洞可以利用upload-lab进行练习；以第一关为例，网站在前端利用JavaScript进行文件后缀名的检测和限制，无法上传php文件，在浏览器禁用js脚本，即可上传一句话木马，实现文件上传漏洞的利用；第二关是对请求的Content-Type字段进行筛选，过滤php文件，通过burpsuite抓包可以修改改字段，完成php文件的上传

webshell管理工具：Godzilla、AntSword、CKnife、冰蝎；由于哥斯拉特征比较明显，可以使用哥斯拉免杀软件进行绕过

获取到中间件是什么（Apache），可以搜索Apache解析漏洞，上传a.php.jpeg，会被解析为php文件；系统命名绕过与系统有关，Windows是大小写不敏感的系统，Linux敏感；也可以扫描常用的端口，寻找可用的漏洞

从网上搜索文件上传绕过，也有很多思路

白名单是只允许上传jpg、png等文件类型，比较难以绕过；黑名单是禁止php后缀上传，比较任意绕过，可以利用Apache文件解析等漏洞进行绕过

php3、php4、phtml等后缀名可整理为字典，放入intruder模块进行爆破；也有一些payload可以对SQL注入漏洞进行爆破；但需要整理好用的payload

java网站上传比较难的原因：
    java搭建的网站不是通过文件的方式去访问的，而是通过mapping调用的方式实现功能，由jar包启动的
    java云安全相关，对于文件的处理可能会专门写一个文件存储桶的接口进行统一管理，成为OSS桶，这种桶没有中间件环境，所以上传的脚本无法被解析。当上传脚本文件时，可能直接上传到桶中从而无法直接访问只能下载，也可能无法下载

java安全漏洞有shiro、fastjson、log4j、springboot

由于java网站很难利用文件上传漏洞，所以一般只能针对使用asp和php语言搭建的网站进行文件上传漏洞的漏洞

任意文件上传漏洞

任意文件下载漏洞：
    对于url中的下载参数可以进行修改，当服务器对下载限制不严格时，可以下载任意文件，例如运用路径穿越下载etc/passwd，查看命令行日志文件

文件包含漏洞：
    专属于PHP网站
    文件包含会把包含的任意文件（无论什么文件类型）中的php代码进行执行
    可以把php脚本写入站点的url，进行访问会在站点访问日志中记录，将该日志包含在php脚本中，则会自动执行日志中url中的php脚本
    其他日志（如Apache的日志也可以利用）
```
