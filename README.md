# YuSunDairy
### 7.1
```
Burpsuite
```
#### 主域名->子域名->IP（比较粗略的信息采集）
##### 主域名
```
Whois查域名 

企查查，天眼查，爱企查-网站备案（查看目标的互联网资产，域名等）-股权结构图/股权穿透图（查看目标单位体系，依照赛方要求根据股权占比确定目标单位） 

以CSU为例，先获取csu.edu.cn的主域名，登录天眼查，可以获取到另外两个域名，收集以上三个域名 

工业和信息化部政务服务管理平台进行ICP/IP地址/域名信息查询，也可以进行中南大学的域名查询，可以获取到三个域名，对天眼查上获取的域名进行了验证 

红队尽可能利用多种平台和工具获取充足的信息，国家平台信息比较完整，但可能纰漏，尽可能利用多个工具补充。
```
##### 子域名
```
收集主域名时要把控股的公司也考虑在内 

子域名相当于二级域名或三级，例如sony.net二级，s.sony.net三级

主动收集：字典枚举（用的多），置换扫描，域传送漏洞，DNSSEC，DNS缓存

字典枚举：subDomainsBrute多并发DNS暴力枚举工具，OneForAll，subFinder，BruteSublist3r， 

试用了subDomainsBrute，从Github上下载，将主域名整理为txt，利用命令行带参数运行subDomainsBrute.py，-f对文件内所有域名枚举，-i对单个域名枚举，先尝试了csu.edu.cn没有枚举到子域名；又尝试了百度，也不行，不好使 

试用了BruteSublist3r，开了Kali虚拟机，从Github上下载，运行sublist3r.py进行枚举，-d单个域名枚举，先尝试了csu.edu.cn，好使，收集到了一系列子域名，对其进行整理

试用了layer子域名挖掘机，可视化界面，但是容易卡死，要把线程调小一些

试用了OneForAll，用得最多，最好用，支持多种爆破方式，从Github上下载，运行oneforall.py进行枚举，--target单个域名，--targets域名列表，枚举过程中运用了多种国内外搜索引擎（google，yahoo等）。查看oneforall目录，查看api.py文件，包括了oneforall调用的搜索引擎接口进行子域名整合，需要自行配置搜索引擎API，以FOFA为例，需要注册后将邮箱和用户KEY进行配置。枚举完成后，对生成的csv文件进行查看，要对子域名进行汇总，有些域名对应多个IP，使用了CDN技术，隐藏了真实IP，所以可以把这些域名删除，只保留域名对应单IP的列，对于生成的ite文件可以使用数据库查看工具Navicat进行查看

对csu.edu.cn进行了oneforall的使用，获取了620个子域名

粗略的信息采集主要通过搜索引擎平台HUNTER，360（QUAKE），FOFA，SHODAN，Virustotal（国外）；以FOFA为例，不同引擎的搜索语法不同，需要查看参考语法，根据语法进行IP、根域名等的查询子域名信息。FOFAViewer有可视化的FOFA，可以利用FOFA的API进行配置使用。无影工具可以整合多个搜索引擎，可以配置各个引擎的API进行信息采集

检索完所有的目标资产，就可以导出所有的资产信息，导出所有的资产信息后，将http或https的协议头替换为空，得到域名
```
##### IP
```
站长之家，可以通过目标域名在全国范围的监测点情况查看目标是否使用了CDN技术，也可以使用PING指令查看PING的实际域名与要PING的域名是否一致，判断目标是否试用了CDN技术。CDN技术一般采用在比较大型的官网，解决全国用户在访问服务器时效率的问题

最好的子域名转IP的方式就是利用PING指令，可以利用Python脚本将域名批量进行PING，去除无法PING到的IP，就得到了对应的IP。将IP进行排序，特别是连续的IP，可以判断数个IP是否在同一C段（202.192.1.6/24），C段指的是同一内网段内的其他服务器，每个IP有ABCD四个段，举个例子，192.168.0.1，A段就是192，B段是168，C段是0，D段是1，而C段嗅探的意思就是拿下它同一C段中的其中一台服务器，也就是说是D段1-255中的一台服务器，然后利用工具嗅探拿下该服务器。通过收集C段可以尽可能获取完全目标资产，特别是不遗失边缘资产，可以搜集在C段内前10或后10的服务器

扫描完IP后，可以进行指定IP的端口扫描，寻找攻击的切入点

Goby可以用于梳理资产面，可以使用常用端口或全端口进行内置的nmap扫描，nmap扫描比较慢，Goby内置了PoC，包含很多漏洞，通过禁用漏洞功能可以只使用扫描功能

由于nmap比较慢而且特征比较明显，现在更多使用masscan。--rate设置扫描速率，-p设置扫描端口范围，--it可以批量扫描ip，扫描ip是攻击行为，需要注意使用

webfinder-next也可以进行扫描，是用java写的

WAF防火墙可以防御端口扫描

在HUNTER利用语法检索可以根据目标HTML文档中的内容进行搜索（标题等），可以获取到可能与主域名相关的资产的IP、域名。通过细化搜索条件，比如web.title（查看HTML文档的title标签）、web.body（查看HTML文档的body标签）、web.icon（查看图标），可以得到更加精确的资产列表

可以使用HUTER的cert进行证书的搜索，搜索使用同一证书的资产信息。使用crt.sh利用证书的指纹中的SHA-256/1进行证书详细信息的获取，可以找到一些使用同一证书的域名。利用Myssl.com/censys可以查找指定和指定资产使用同一证书的其他域名。
```
#### 对于已发现资产的漏洞挖掘和扫描
```
0day->1day->nday

讲了SpringBoot的Actuator未授权访问漏洞，由于很多web应用的开发都使用了SpringBoot，所以可能可以利用框架的漏洞对资产进行攻击。可以使用360Finger-P对网站的使用框架进行识别，根据使用的框架中已被发现的漏洞可以进行测试。使用BP，输入已被发现的Jeecg框架的漏洞PoC，替换host和其他信息，发现漏洞已被修复，类似的思路可用于其他漏洞

PoC是去检测是否存在漏洞，EXP是利用漏洞

可以在CNVD上查看漏洞，但无法查看PoC，利用CNVD编号可以搜索PoC复现

实际打点由于时间紧张主要使用nday漏洞

使用afrog进行漏洞扫描，包括1400余个PoC。也可以使用nuclei进行漏洞扫描，编写包含漏洞的yaml文件可以进行针对性扫描

Java常见框架漏洞：shiro（有readme的特征，很容易识别），SpringBoot，log4j（jndi注入，查看能否从外网获取外部类使用，nuclei无法检测），Fastjson，struts2

xray（内置Payload）+rad（爬取接口）可以检测log4j的SQL注入漏洞，rad爬取接口，发给xray进行漏洞扫描

在xray上配置反连平台可以扫描更多的漏洞，如log4j和struts2的漏洞
```
#### 案例分析
```
除了资产信息，还需要搜集用户的敏感信息

以中南林业科技大学为例

使用google搜索的site搜索所有关于目标域名的站点，发现校园邮箱，用户名为教工号，密码与身份证有关，因此需要搜索个人身份信息。通过搜索目标单位的个人电话号码，可以获取到个人姓名和手机号，利用社工库可以进行敏感信息的获取，通过弱口令可以登录校园邮箱，使用yakit进行抓包可以在通讯录跳转处获取到所有其他用户的邮箱、电话号码等信息，进而控制更多邮箱。通过目标VPN可以进入内网，扩大战果
```

### 7.2
#### 弱口令、验证码、爆破
```
先对资产进行漏洞扫描，使用Wappalyzer对网站使用的技术栈进行剖析，查找技术栈中的技术是否存在可以利用的如1day、nday等漏洞，随后优先针对后台进行测试

网站前端代码三件套：HTML+CSS+JS，vue.js。通过浏览器查看源码可以看到源码，也可以修改前段代码造成XSS漏洞，XSS漏洞是用户可以在前端写入JavaScript语句，使得JS语句在前端可以运行

后端开发脚本：PHP、ASP、ASP.NET、JavaWeb（大部分使用、稳定、高并发），可以通过文件上传，上传恶意代码在服务器端执行，要根据网站的搭建语言来针对性构建对应语言的恶意代码脚本上传，不然无法运行；Web中间件/服务器（解析后端开发脚本并执行）：Nginx（PHP）、IIS（ASP+ASP.NET）、Tomcat（JavaWeb）、Apache（Kali自带），中间件也存在很多漏洞，可以加以利用；以Nginx为例，Nginx存在解析和截断漏洞

服务器端经常会有数据库操作，所以也可以构造一些数据库查询的语句，如SQL语句，这些语句可以在服务器端的数据库执行，造成SQL注入漏洞
```
#### 弱口令
```
用户名枚举漏洞是利用对于用户名是否存在的回显信息可以测试得出用户的用户名，如果无法得出，可以利用常见的用户名进行爆破，可以使用BP的Inturder模块，由于只需要爆破单个目标，可以使用Sniper爆破，当爆破速率过高且目标具有WAF防火墙时，可能会被BAN掉，因此需要合理设置爆破速率，模拟真实访问的请求；如果无法区分是否爆破成功，在爆破设置中可以对返回页面的指定内容进行标记，根据爆破返回的标记情况区分爆破是否成功

以www.dslawyer.com为例，先利用用户名枚举得到admin用户名，在登录时抓包并拦截，发送到Intruder，不能释放数据包，利用验证码复用漏洞使多次爆破使用同一验证码，利用字典对admin用户的密码进行爆破，根据返回数据包的长度、返回状态码（3XX重定向），可以发现密码为123654，可以成功进行登录。真实攻击还是要使用更深层次的漏洞，如SQL注入、文件上传等漏洞

常见系统的弱口令：XXLJOB任务调度系统（默认账号admin，默认密码123456）、K8s控制台（默认账号admin，默认密码P@88w0rd）、ZABBIX系统监控（默认账号admin、默认密码zabbix）、activeMQ组件（默认账号admin/、默认密码admin）、NACOS系统监控（默认账号NACOS、默认密码NACOS）、Grafana控制台（默认账号admin、默认密码admin）、Druid组件（默认账号admin、默认密码123456）、若依（默认账号admin、默认密码admin123）。通过XXLJOB可以在shell、powershell等执行指定参数命令，常见的是NACOS和XXLJOB

除了传统字典，还有社工字典工具TscanPlus，有社工模式、组合模式、枚举模式，可以生成多种密码
```
### 业务逻辑漏洞
```
包括支付漏洞、越权漏洞、密码找回、信息泄露、积分兑换和抽奖

密码找回漏洞可以用于进行用户名枚举，一般校验流程是首先输入自己的手机号，随后服务器会对手机号进行验证，检查是否存在用户，填写验证码证明是本人操作，随后填写新密码进行重置。漏洞主要存在于填写验证码和新的密码这一部分，讲了兰州市城关区智慧教育云平台的例子，其没有对发送验证码的手机号码做验证，导致可以绕过验证码，进而修改密码;
使用PortSwigger的密码重置破坏逻辑实验的例子，进行了密码找回漏洞的实验


支付漏洞可以把金额改为负数，实现0元购。使用墨者靶场进行了支付漏洞的实验

越权访问漏洞包括水平越权和垂直越权，水平越权是同级用户之间可以越权进行操作，而垂直越权是不同级别或不同角色之间的角色之间的越权操作，如普通用户可以执行管理员才能执行的功能。越权访问漏洞主要发生在Cookie验证不严，简单判断用户提交的参数的情况，本质上是这些参数在客户端提交，但没有在服务器严格进行校验。举了飞飞影视导航系统的例子，登录用户后可以修改url实现水平越权。还举了湖南省全员核酸检测小程序的例子，通过遍历用户ID，可以获取千万级的用户信息

测试水平越权可以注册普通账号进行测试，垂直越权的测试思路是如何获取管理员用户权限，根据泄露的大量接口使用普通用户去测试哪些接口是管理用户特权
```
### 7.3
#### 作业讲解
```
.htaccess是Apache用来控制文件访问的配置文件，其中Addtype会规定文件上传的类型，会在HTML文档中执行，所以无法上传php等文件
```
#### SQL注入
##### 基础与注入方式
```
审计代码，可以在后台php代码中发现对数据库操作的语句，其中有参数需要用户输入，这提供了用户与数据库交互的操作，但也提供了SQL注入的接口，当攻击者发现这一点并加以利用时，可以构造特定的SQL语句，例如拼接and进行数据库键的枚举、拼接or得到所有信息、拼接sleep函数根据延时结果判断数据数量、拼接union联合查询得到数据库的名称和数据库用户名称等

SQL注入的防范需要对用户输入的参数进行处理，例如禁用一些函数和特殊符号，再与SQL语句进行拼接

SQL_labs是练习SQL注入的平台，可以在Github上找到；有些php代码会将用户输入的数据库查询参数用单引号引起，这时需要用单引号闭合，再在单引号后进行拼接，之后常用注释符--+将SQL语句分隔开

SQL注入的类型可以分为数字型和字符型（' " (），数字型的站点直接将用户输入的参数作为SQL语句的一部分，不加符号包裹，字符型的站点在用户输入的参数外加了符号包裹，需要对符号做闭合处理

SQL注入的方向可以分为有回显和无回显，有回显的站点会输出数据库的报错信息，由此可以判断是否存在SQL注入漏洞，无回显的站点无论用户输入了什么数据库查询参数都不会返回报错信息；有回显包括联合查询和报错注入，有回显可以用来布尔盲注，无回显可以用来延时注入

当界面中存在回显位时，可以使用联合查询。联合查询需要知道前面对于数据库的查询会输出多少列，如果列数不一致则会报错，所以在联合查询之前可以使用order by进行排序，当order by的参数大于列数时会报错。如果只想要联合查询的值，可以将前面查询的条件设为永假，则会显示联合查询的结果

举了两个实例站点的例子，通过修改URL先测试单引号闭合，随后添加注释符，并在注释符前拼接SQL语句，先利用order by测试出数据库的列数为8，然后利用联合查询先确定回显位，再修改SQL语句参数在回显位显示数据库用户名、版本号等信息，可以得到用户名为Mainweb，且得知数据库为MariaDB

报错注入是利用updatexml函数在报错信息中获取敏感信息，updatexml函数包含三个参数，第一个是XML文档对象的名称，第二个是文档的XPATH路径，第三个是要赋的新值，重点是第二个参数，可以利用在报错信息中泄露信息；extractvalue函数也很常用，有两个参数，报错位置在第二个参数，比较复杂的报错需要使用concat进行拼接；在测试站点进行了实验，成功利用报错注入得到了站点的数据库版本等信息

WAF可以拦截updatexml和extractvalue函数

在通过database()知道了数据库后，需要获取表，这可以通过内置库的tables表的TABLE_NAME字段获取，通过限制条件TABLE_SCHEMA字段为以获取的数据库，可以得到已知数据库下的所有表；下一步是针对表名获取所有列名

大于等于5.7版本的MySQL内置了四个库，最重要的information_schema这个库，包括三张表，分别是schemata（存放所有数据库信息）、tables（存放所有表信息）、columns（存放所有列信息），使用limit限制输出，可以遍历得到所有需要的信息；以sqllib的站点为例获取了security库下的所有表名

concat可以拼接多个字段为一个字段，group_concat可以将多个字段拼接为一个字段的一条数据，这个字段包括concat的所有拼接数据（concat是多行，group_concat把多行合并为一行），group_concat不能用于报错注入

盲注是指站点只有两种回显，一种是报错的回显，一种是不报错的回显，但不会显示报错信息，因此不能使用报错注入，只能使用布尔盲注。布尔盲注的常用SQL函数有substr（对未知字符串的指定位置子串进行比较，根据回显是否正确确定每一位的字符，枚举得出完整的字符串）、mid（和substr一样）、substring（和substr一样）、length（计算未知字符串的长度，枚举可能的长度，根据回显是否正确确定字符串长度）、left（从左往右开始对未知字符串取指定长度的子串，枚举后根据回显是否正确确定字符串）、right（left反过来）、ascii（将字符的ASCII码转为整数型）、ord、char；以SQLLab的第八关为例，先用length函数确认数据库名称的长度为8，随后使用substr函数判断数据库名称的第一位为a，如果需要批量判断，可以使用if，第一个参数是布尔表达式，第二第三个参数分别为真和假时执行的操作，使用burpsuite进行抓包，利用intruder模块和if进行批量判断，根据爆破结果得到正确的数据库名。

延时注入是利用sleep函数进行延时，通过与if搭配进行使用，但if有时会被禁用，所以常用case when 布尔表达式 then 真的操作 else 假的操作 end句式进行替换，也可以使用benchmark函数，会计算count次表达式，第一个参数是count，第二个是要计算的表达式

SQL注入bypass，如果空格被过滤，可以使用引号和括号绕过；逗号被绕过，对于substr和mid即使没有逗号也可以用from和for代替，除此之外还可以绕过比较运算符和注释符等

最好在本地搭建MySQL（3306）、Oracle（1521）、MsSQL（1433）、PostgreSQL（5432）、Redis（6789），以便在本地查看数据库；MySQL、MsSQL、Oracle都可以使用case when句式，MySQL可以使用if函数，MsSQL和Oracle无法使用if函数，MsSQL可以使用iif函数，Oracle可以使用decode函数，包含4个参数，第一个参数是布尔表达式的左数，第二个参数是布尔表达式的右数，第三个参数和第四个参数分别是真假的操作

用户函数：MySQL主要用user、current_user、session_user、system_user；MsSQL主要用user_name、user、system_user、suser_sname；Oracle主要用user、current_user、session_user

SQLmap是SQL注入的自动化测试工具，可以检测出时延等漏洞，可以在Github下载，是一个Python的脚本；GET请求方式python sqlmap.py -u https://www,burobd.org/network-and-linkages.php?id=1 -p id；POST请求方式有两种：保存成txt文档使用python sqlmap.py -r 1.txt（数据包复制为txt） -p id；使用--data参数python sqlmap.py https://www,burobd.org/network-and-linkages.php --data="id=1*"；第二种方式可能需要Cookie，所以建议使用第一种方式将抓到的数据包保存为文档去跑

常用的参数：

    自动化测试参数-batch，该参数会自动确认添加负载

    风险等级测试参数--level=1-5：一般建议使用3，风险等级越高测试的payload越多；--risk=0-2

    清除缓存测试参数--flush-session：清除之前测试的缓存

    指定SQL注入测试类型参数--technique=BEUSTQ

    代理参数--proxy=http://127.0.0.1:8080：可以对SQLmap的payload进行分析

    调试模式-vvv：会显示测试使用的payload

    绕过waf的参数--tamper=space2randomblank：当测试发现WAF存在字符过滤时，可以使用脚本进行转换

针对于利用的参数：

    获取数据库名称--current-db

    获取数据库用户--current-user
    
    查看当前用户是否为DBA（管理员）权限--is-db

    查询所有数据库名称--dbs

    查询指定数据库的所有表名-D 数据库名 --tables

    查询指定数据库指定表的所有列名-D 数据库名称 -T 表名 --columns

    查询字段-D 数据库名 -T 表名 -C 字段名 --dump

    数据库交互--sql-shell：可以执行查询操作

    服务器交互--os-shell：不要用-batch，需要选择站点的后台代码语言，输入站点在服务器的绝对路径

    写入文件--file-write xxx/a.php（本地文件） --file-dest xxx/yyy（服务器目录）：也需要站点在服务器上的绝对路径，可以上传一句话木马
···
### 7.4
#### 作业讲解
```
打开靶机，利用nmap找到靶机的IP，在Burpsuite的浏览器中访问靶机IP，利用dirb或dirsearch对靶机进行目录扫描，利用-x参数可以屏蔽指定的返回状态码，简化扫描的目录列表；找到robots.txt，是网站搭建的默认文件，可以在里面找到站点的一些目录，对其中一个目录访问可以发现站点具有SQL注入漏洞，是采用POST请求进行的，运行SQLMap进行测秒，在这里需要确认一下MySQL数据库版本信息，在5.5版本以前，secure_file_priv默认是空，这个情况下可以向任意绝对路径写文件；在5.5版本之后，secure_file_priv默认是NULL，这个情况下不可以写文件，也可能是一个目录，即只允许向该目录写入文件。对robots.txt下的目录进行递归扫描发现了phpinfo文件，其中显示了网站的绝对路径、操作系统信息，用SQLMap向uploads目录下上传三个php文件，其中一个文件可以利用cmd参数进行shell命令的运行，另一个文件可以上传文件，上传哥斯拉木马，访问哥斯拉木马，然后在哥斯拉进行查看；也可以在获取了网站的绝对路径后将哥斯拉的木马直接上传到uploads文件。随后使用哥斯拉进行数据库管理，利用获取到的数据库用户名和密码连接数据库，获取需要的信息

首先需要确认secure_file_priv是否为空；其次需要网站的绝对路径，可以通过网站的报错信息、phpinfo、/var/www/html（Ubuntu）；之后要确定网站的目录权限，是否有写入权限

--os-shell：MySQL的--os-shell参数是SQLMap向服务器写入了自己内置的一个木马，MsSQL的--os-shell参数是SQLMap打开了MsSQL的xp_cmdshell的一个函数
```
#### 文件上传漏洞
```
如果我们可以上传脚本文件到服务器，使脚本文件被运行，脚本文件可以包括大量与系统交互的函数，例如常见的一句话木马<?php @eval($_POST['cmd']);?>，意思是当向php脚本文件传入参数cmd=system('ls');时，传入参数cmd会作为PHP命令执行，可以执行系统外部命令（如system()、exec()、passthru()），也可以将木马改为GET以及其他形式

流程是攻击者上传恶意文件到服务器，恶意代码在服务器被运行，运行结果返回给攻击者

文件上传漏洞利用成功的条件：上传的脚本文件可以被解析；需要知道上传文件的路径

文件上传漏洞可以利用upload-lab进行练习；以第一关为例，网站在前端利用JavaScript进行文件后缀名的检测和限制，无法上传php文件，在浏览器禁用js脚本，即可上传一句话木马，实现文件上传漏洞的利用；第二关是对请求的Content-Type字段进行筛选，过滤php文件，通过burpsuite抓包可以修改改字段，完成php文件的上传

webshell管理工具：Godzilla、AntSword、CKnife、冰蝎；由于哥斯拉特征比较明显，可以使用哥斯拉免杀软件进行绕过

获取到中间件是什么（Apache），可以搜索Apache解析漏洞，上传a.php.jpeg，会被解析为php文件；系统命名绕过与系统有关，Windows是大小写不敏感的系统，Linux敏感；也可以扫描常用的端口，寻找可用的漏洞

从网上搜索文件上传绕过，也有很多思路

白名单是只允许上传jpg、png等文件类型，比较难以绕过；黑名单是禁止php后缀上传，比较任意绕过，可以利用Apache文件解析等漏洞进行绕过
```

