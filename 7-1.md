### 7.1
```
Burpsuite
```
#### 主域名->子域名->IP（比较粗略的信息采集）
##### 主域名
```
Whois查域名 

企查查，天眼查，爱企查-网站备案（查看目标的互联网资产，域名等）-股权结构图/股权穿透图（查看目标单位体系，依照赛方要求根据股权占比确定目标单位） 

以CSU为例，先获取csu.edu.cn的主域名，登录天眼查，可以获取到另外两个域名，收集以上三个域名 

工业和信息化部政务服务管理平台进行ICP/IP地址/域名信息查询，也可以进行中南大学的域名查询，可以获取到三个域名，对天眼查上获取的域名进行了验证 

红队尽可能利用多种平台和工具获取充足的信息，国家平台信息比较完整，但可能纰漏，尽可能利用多个工具补充。
```
##### 子域名
```
收集主域名时要把控股的公司也考虑在内 

子域名相当于二级域名或三级，例如sony.net二级，s.sony.net三级

主动收集：字典枚举（用的多），置换扫描，域传送漏洞，DNSSEC，DNS缓存

字典枚举：subDomainsBrute多并发DNS暴力枚举工具，OneForAll，subFinder，BruteSublist3r， 

试用了subDomainsBrute，从Github上下载，将主域名整理为txt，利用命令行带参数运行subDomainsBrute.py，-f对文件内所有域名枚举，-i对单个域名枚举，先尝试了csu.edu.cn没有枚举到子域名；又尝试了百度，也不行，不好使 

试用了BruteSublist3r，开了Kali虚拟机，从Github上下载，运行sublist3r.py进行枚举，-d单个域名枚举，先尝试了csu.edu.cn，好使，收集到了一系列子域名，对其进行整理

试用了layer子域名挖掘机，可视化界面，但是容易卡死，要把线程调小一些

试用了OneForAll，用得最多，最好用，支持多种爆破方式，从Github上下载，运行oneforall.py进行枚举，--target单个域名，--targets域名列表，枚举过程中运用了多种国内外搜索引擎（google，yahoo等）。查看oneforall目录，查看api.py文件，包括了oneforall调用的搜索引擎接口进行子域名整合，需要自行配置搜索引擎API，以FOFA为例，需要注册后将邮箱和用户KEY进行配置。枚举完成后，对生成的csv文件进行查看，要对子域名进行汇总，有些域名对应多个IP，使用了CDN技术，隐藏了真实IP，所以可以把这些域名删除，只保留域名对应单IP的列，对于生成的ite文件可以使用数据库查看工具Navicat进行查看

对csu.edu.cn进行了oneforall的使用，获取了620个子域名

粗略的信息采集主要通过搜索引擎平台HUNTER，360（QUAKE），FOFA，SHODAN，Virustotal（国外）；以FOFA为例，不同引擎的搜索语法不同，需要查看参考语法，根据语法进行IP、根域名等的查询子域名信息。FOFAViewer有可视化的FOFA，可以利用FOFA的API进行配置使用。无影工具可以整合多个搜索引擎，可以配置各个引擎的API进行信息采集

检索完所有的目标资产，就可以导出所有的资产信息，导出所有的资产信息后，将http或https的协议头替换为空，得到域名
```
##### IP
```
站长之家，可以通过目标域名在全国范围的监测点情况查看目标是否使用了CDN技术，也可以使用PING指令查看PING的实际域名与要PING的域名是否一致，判断目标是否试用了CDN技术。CDN技术一般采用在比较大型的官网，解决全国用户在访问服务器时效率的问题

最好的子域名转IP的方式就是利用PING指令，可以利用Python脚本将域名批量进行PING，去除无法PING到的IP，就得到了对应的IP。将IP进行排序，特别是连续的IP，可以判断数个IP是否在同一C段（202.192.1.6/24），C段指的是同一内网段内的其他服务器，每个IP有ABCD四个段，举个例子，192.168.0.1，A段就是192，B段是168，C段是0，D段是1，而C段嗅探的意思就是拿下它同一C段中的其中一台服务器，也就是说是D段1-255中的一台服务器，然后利用工具嗅探拿下该服务器。通过收集C段可以尽可能获取完全目标资产，特别是不遗失边缘资产，可以搜集在C段内前10或后10的服务器

扫描完IP后，可以进行指定IP的端口扫描，寻找攻击的切入点

Goby可以用于梳理资产面，可以使用常用端口或全端口进行内置的nmap扫描，nmap扫描比较慢，Goby内置了PoC，包含很多漏洞，通过禁用漏洞功能可以只使用扫描功能

由于nmap比较慢而且特征比较明显，现在更多使用masscan。--rate设置扫描速率，-p设置扫描端口范围，--it可以批量扫描ip，扫描ip是攻击行为，需要注意使用

webfinder-next也可以进行扫描，是用java写的

WAF防火墙可以防御端口扫描

在HUNTER利用语法检索可以根据目标HTML文档中的内容进行搜索（标题等），可以获取到可能与主域名相关的资产的IP、域名。通过细化搜索条件，比如web.title（查看HTML文档的title标签）、web.body（查看HTML文档的body标签）、web.icon（查看图标），可以得到更加精确的资产列表

可以使用HUTER的cert进行证书的搜索，搜索使用同一证书的资产信息。使用crt.sh利用证书的指纹中的SHA-256/1进行证书详细信息的获取，可以找到一些使用同一证书的域名。利用Myssl.com/censys可以查找指定和指定资产使用同一证书的其他域名。
```
#### 对于已发现资产的漏洞挖掘和扫描
```
0day->1day->nday

讲了SpringBoot的Actuator未授权访问漏洞，由于很多web应用的开发都使用了SpringBoot，所以可能可以利用框架的漏洞对资产进行攻击。可以使用360Finger-P对网站的使用框架进行识别，根据使用的框架中已被发现的漏洞可以进行测试。使用BP，输入已被发现的Jeecg框架的漏洞PoC，替换host和其他信息，发现漏洞已被修复，类似的思路可用于其他漏洞

PoC是去检测是否存在漏洞，EXP是利用漏洞

可以在CNVD上查看漏洞，但无法查看PoC，利用CNVD编号可以搜索PoC复现

实际打点由于时间紧张主要使用nday漏洞

使用afrog进行漏洞扫描，包括1400余个PoC。也可以使用nuclei进行漏洞扫描，编写包含漏洞的yaml文件可以进行针对性扫描

Java常见框架漏洞：shiro（有readme的特征，很容易识别），SpringBoot，log4j（jndi注入，查看能否从外网获取外部类使用，nuclei无法检测），Fastjson，struts2

xray（内置Payload）+rad（爬取接口）可以检测log4j的SQL注入漏洞，rad爬取接口，发给xray进行漏洞扫描

在xray上配置反连平台可以扫描更多的漏洞，如log4j和struts2的漏洞
```
#### 案例分析
```
除了资产信息，还需要搜集用户的敏感信息

以中南林业科技大学为例

使用google搜索的site搜索所有关于目标域名的站点，发现校园邮箱，用户名为教工号，密码与身份证有关，因此需要搜索个人身份信息。通过搜索目标单位的个人电话号码，可以获取到个人姓名和手机号，利用社工库可以进行敏感信息的获取，通过弱口令可以登录校园邮箱，使用yakit进行抓包可以在通讯录跳转处获取到所有其他用户的邮箱、电话号码等信息，进而控制更多邮箱。通过目标VPN可以进入内网，扩大战果
```
